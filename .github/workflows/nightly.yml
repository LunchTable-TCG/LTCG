name: Nightly Full Test Suite

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  comprehensive-tests:
    name: Full Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps

      - name: Start Convex dev server
        run: bunx convex dev &
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEPLOYMENT_TEST }}

      - name: Wait for Convex
        run: sleep 10

      - name: Run unit tests
        run: bun run test:unit

      - name: Run Convex tests (if server available)
        run: bun run test:convex || echo "Convex tests skipped"
        continue-on-error: true

      - name: Generate types
        run: bun run generate:types

      - name: Start web server
        run: bun run dev &
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEPLOYMENT_TEST }}
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL_TEST }}

      - name: Wait for web server
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3333 > /dev/null 2>&1; do sleep 2; done' || true

      - name: Run E2E smoke tests
        run: bun run test:e2e:smoke
        env:
          BASE_URL: http://localhost:3333

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            playwright-report/
            coverage/
            test-results/
          retention-days: 7

  test-coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate coverage
        run: bun run test:coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: ltcg-coverage
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run benchmarks
        run: |
          echo "Performance benchmarks would run here"
          echo "Examples: Lighthouse, load testing, etc."

  dependency-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Security audit
        run: |
          echo "Running security audit..."
          # Bun doesn't have built-in audit yet, but you can use npm audit
          # npm audit --audit-level=high || true

  nightly-summary:
    name: Nightly Summary
    runs-on: ubuntu-latest
    needs: [comprehensive-tests, test-coverage, performance-benchmarks, dependency-audit]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## Nightly Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.comprehensive-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: ${{ needs.test-coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Benchmarks: ${{ needs.performance-benchmarks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
