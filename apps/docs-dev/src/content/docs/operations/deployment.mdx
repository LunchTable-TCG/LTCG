---
title: Deployment
description: Deploying LunchTable TCG to production
---

import { Aside, Steps, Tabs, TabItem } from '@astrojs/starlight/components';

## Overview

LunchTable TCG uses Vercel for frontend deployments and Convex for the backend. Both support automatic deployments from git.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        PRODUCTION                            │
│                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │   Vercel     │    │   Convex     │    │   Clerk      │  │
│  │  (Frontend)  │───▶│  (Backend)   │◀───│   (Auth)     │  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
│         │                   │                    │          │
│         └───────────────────┴────────────────────┘          │
│                             │                                │
│                    ┌────────┴────────┐                      │
│                    │   Cloudflare    │                      │
│                    │     (CDN)       │                      │
│                    └─────────────────┘                      │
└─────────────────────────────────────────────────────────────┘
```

## Frontend Deployment (Vercel)

### Initial Setup

<Steps>

1. **Connect repository**

   Link your GitHub repo in the Vercel dashboard.

2. **Configure build settings**

   ```json
   // vercel.json
   {
     "buildCommand": "bun run build",
     "installCommand": "bun install",
     "framework": "nextjs"
   }
   ```

3. **Set environment variables**

   Required variables:
   ```bash
   NEXT_PUBLIC_CONVEX_URL=https://your-project.convex.cloud
   NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_...
   CLERK_SECRET_KEY=sk_...
   ```

4. **Deploy**

   ```bash
   vercel --prod
   ```

</Steps>

### Branch Deployments

| Branch | Environment | URL |
|--------|-------------|-----|
| `main` | Production | ltcg.io |
| `staging` | Staging | staging.ltcg.io |
| `*` | Preview | random-slug.vercel.app |

## Backend Deployment (Convex)

### Initial Setup

<Steps>

1. **Login to Convex**

   ```bash
   bunx convex login
   ```

2. **Deploy to production**

   ```bash
   bunx convex deploy --prod
   ```

3. **Set environment variables**

   ```bash
   bunx convex env set CLERK_ISSUER_URL https://...
   bunx convex env set CLERK_WEBHOOK_SECRET whsec_...
   ```

</Steps>

### Development vs Production

<Tabs>
  <TabItem label="Development">
    ```bash
    # Starts local dev server with hot reload
    bunx convex dev
    ```
    - Uses development deployment
    - Real-time schema updates
    - Debug logging enabled
  </TabItem>
  <TabItem label="Production">
    ```bash
    # Deploys to production
    bunx convex deploy --prod
    ```
    - Requires schema compatibility
    - Runs migrations if needed
    - Production logging only
  </TabItem>
</Tabs>

## CI/CD Pipeline

### GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - name: Run tests
        run: bun run test

      - name: Deploy Convex
        run: bunx convex deploy --prod
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Deploy Vercel
        run: vercel --prod --token=${{ secrets.VERCEL_TOKEN }}
```

## Database Migrations

### Schema Changes

<Aside type="caution">
  Always test migrations on staging before production!
</Aside>

```typescript
// convex/migrations/addNewField.ts
import { migration } from "../lib/migrations";

export default migration({
  table: "users",
  batchSize: 100,
  migrateOne: async (ctx, doc) => {
    return {
      ...doc,
      newField: "default_value",
    };
  },
});
```

### Running Migrations

```bash
# Dry run
bunx convex run migrations:addNewField --dry-run

# Execute
bunx convex run migrations:addNewField
```

## Rollback Procedures

### Frontend Rollback

```bash
# List deployments
vercel ls

# Rollback to previous
vercel rollback [deployment-id]
```

### Backend Rollback

<Aside type="danger">
  Backend rollbacks may require data migrations. Plan carefully.
</Aside>

1. Identify the last working commit
2. Revert changes in a new commit
3. Deploy the revert
4. Run any necessary data fixes

## Environment Configuration

### Required Variables

| Variable | Service | Description |
|----------|---------|-------------|
| `CONVEX_DEPLOY_KEY` | Convex | CI deployment key |
| `CLERK_SECRET_KEY` | Clerk | Backend auth |
| `CLERK_WEBHOOK_SECRET` | Clerk | Webhook verification |

### Optional Variables

| Variable | Description |
|----------|-------------|
| `SENTRY_DSN` | Error tracking |
| `ANALYTICS_ID` | Analytics tracking |

---

## Related

import { LinkCard, CardGrid } from '@astrojs/starlight/components';

<CardGrid>
  <LinkCard
    title="Monitoring"
    description="Production monitoring"
    href="/operations/monitoring/"
  />
  <LinkCard
    title="Security"
    description="Security practices"
    href="/operations/security/"
  />
</CardGrid>
