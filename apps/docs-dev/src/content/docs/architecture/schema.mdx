---
title: Database Schema
description: Convex database schema reference
---

import { Aside } from '@astrojs/starlight/components';

## Overview

LunchTable TCG uses Convex as its database, which is a document-based, real-time database with built-in TypeScript support.

## Core Tables

### users

User profiles and authentication.

```typescript
users: defineTable({
  privyId: v.string(),
  username: v.string(),
  displayName: v.optional(v.string()),
  avatarUrl: v.optional(v.string()),
  level: v.number(),
  xp: v.number(),
  gold: v.number(),
  gems: v.number(),
  lunchMoney: v.number(),
  createdAt: v.number(),
  lastLoginAt: v.number(),
})
  .index("by_privyId", ["privyId"])
  .index("by_username", ["username"])
```

### cards

Card definitions (not instances).

```typescript
cards: defineTable({
  name: v.string(),
  type: v.union(
    v.literal("creature"),
    v.literal("spell"),
    v.literal("trap")
  ),
  element: elementValidator,
  rarity: rarityValidator,
  cost: v.number(),
  attack: v.optional(v.number()),
  health: v.optional(v.number()),
  description: v.string(),
  flavorText: v.optional(v.string()),
  abilities: v.array(abilityValidator),
  imageUrl: v.optional(v.string()),
  isActive: v.boolean(),
})
  .index("by_element", ["element"])
  .index("by_type", ["type"])
  .index("by_rarity", ["rarity"])
```

### decks

User deck configurations.

```typescript
decks: defineTable({
  userId: v.id("users"),
  name: v.string(),
  description: v.optional(v.string()),
  cards: v.array(v.object({
    cardId: v.id("cards"),
    count: v.number(),
  })),
  primaryElement: v.optional(elementValidator),
  isValid: v.boolean(),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_userId", ["userId"])
```

## Game Tables

### gameLobbies

Pre-game lobbies.

```typescript
gameLobbies: defineTable({
  hostId: v.id("users"),
  players: v.array(v.id("users")),
  gameMode: v.union(
    v.literal("ranked"),
    v.literal("casual"),
    v.literal("draft")
  ),
  status: v.union(
    v.literal("waiting"),
    v.literal("starting"),
    v.literal("started")
  ),
  settings: v.optional(gameSettingsValidator),
  createdAt: v.number(),
})
  .index("by_host", ["hostId"])
  .index("by_status", ["status"])
```

### games

Active game state.

```typescript
games: defineTable({
  lobbyId: v.optional(v.id("gameLobbies")),
  player1: playerStateValidator,
  player2: playerStateValidator,
  currentTurn: v.number(),
  currentPhase: turnPhaseValidator,
  activePlayerId: v.id("users"),
  status: gameStatusValidator,
  turnHistory: v.array(turnActionValidator),
  effectStack: v.array(effectValidator),
  startedAt: v.number(),
  endedAt: v.optional(v.number()),
  winnerId: v.optional(v.id("users")),
})
  .index("by_player", ["player1.playerId"])
  .index("by_status", ["status"])
```

<Aside type="note">
  The `games` table uses nested validators for complex state. See the full schema in `convex/schema.ts`.
</Aside>

## Economy Tables

### shopProducts

Items available for purchase.

```typescript
shopProducts: defineTable({
  name: v.string(),
  description: v.string(),
  category: v.union(
    v.literal("packs"),
    v.literal("bundles"),
    v.literal("cosmetics"),
    v.literal("battle-pass")
  ),
  price: v.object({
    currency: currencyValidator,
    amount: v.number(),
  }),
  contents: productContentsValidator,
  imageUrl: v.optional(v.string()),
  isActive: v.boolean(),
  sortOrder: v.number(),
})
  .index("by_category", ["category"])
```

### marketListings

Player-to-player marketplace.

```typescript
marketListings: defineTable({
  sellerId: v.id("users"),
  cardId: v.id("cards"),
  variant: v.optional(variantValidator),
  price: v.number(),
  listedAt: v.number(),
  expiresAt: v.number(),
  status: v.union(
    v.literal("active"),
    v.literal("sold"),
    v.literal("cancelled"),
    v.literal("expired")
  ),
  buyerId: v.optional(v.id("users")),
  soldAt: v.optional(v.number()),
})
  .index("by_seller", ["sellerId"])
  .index("by_card", ["cardId"])
  .index("by_status", ["status"])
```

## Progression Tables

### battlePassProgress

User battle pass state.

```typescript
battlePassProgress: defineTable({
  userId: v.id("users"),
  seasonId: v.id("seasons"),
  tier: v.number(),
  xp: v.number(),
  isPremium: v.boolean(),
  claimedRewards: v.array(v.number()),
})
  .index("by_user_season", ["userId", "seasonId"])
```

### achievements

User achievement progress.

```typescript
achievements: defineTable({
  userId: v.id("users"),
  achievementId: v.string(),
  progress: v.number(),
  target: v.number(),
  completed: v.boolean(),
  completedAt: v.optional(v.number()),
})
  .index("by_user", ["userId"])
```

## Validators

Common validators used across tables:

```typescript
// Element types
const elementValidator = v.union(
  v.literal("ember"),
  v.literal("frost"),
  v.literal("nature"),
  v.literal("arcane"),
  v.literal("void"),
  v.literal("neutral")
);

// Rarity types
const rarityValidator = v.union(
  v.literal("common"),
  v.literal("uncommon"),
  v.literal("rare"),
  v.literal("epic"),
  v.literal("legendary")
);

// Turn phases
const turnPhaseValidator = v.union(
  v.literal("draw"),
  v.literal("main1"),
  v.literal("battle"),
  v.literal("main2"),
  v.literal("end")
);
```

---

## Related

import { LinkCard, CardGrid } from '@astrojs/starlight/components';

<CardGrid>
  <LinkCard
    title="Game Engine"
    description="How the game logic works"
    href="/architecture/game-engine/"
  />
  <LinkCard
    title="Effect System"
    description="Card abilities and effects"
    href="/architecture/effect-system/"
  />
</CardGrid>
